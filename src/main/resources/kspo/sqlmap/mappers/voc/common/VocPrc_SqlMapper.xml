<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kspo.voc.kspo.common.dao.IVocPrcDao">

    <resultMap type="com.kspo.voc.kspo.setting.model.VocActivityVo" id="VocActivityVo">
        <result property="explanation"  column="EXPLANATION"  jdbcType="CLOB" javaType="java.lang.String" />
    </resultMap>

    <sql id="vocManagementCodeCols">
        MANAGEMENT_CD,
        TOP_CD,
        PRNTS_CD,
        TOP_COMN_CD,
        COMN_CD,
        ODRG,
        LVL,
        CODE_NM,
        USE_YN,
        REGR_ID,
        REG_DT,
        AMDR_ID,
        AMD_DT
    </sql>

    <select id="selectVocManagementCodeTree" resultType="com.kspo.voc.kspo.setting.model.VocManagementCodeVo">
        select
            <include refid="vocManagementCodeCols"/>
        from
            tb_voc_management_cd_bas
        <where>
            <if test="topComnCd != null and !topComnCd.equals('')">
                top_comn_cd = #{topComnCd}
            </if>
            <!-- 단건의 분류코드 그룹 호출 시 -->
            <if test="comnCd instanceof String">
                and
                comn_cd = #{comnCd}
            </if>
            <!-- 여러개의 분류코드 그룹 호출 시 -->
            <if test="comnCd instanceof java.util.ArrayList">
                and
                comn_cd in
                <foreach collection="comnCd" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        order by
            MANAGEMENT_CD
    </select>

    <select id="selectManagementCode" resultType="com.kspo.voc.kspo.setting.model.VocManagementCodeVo">
        select
            <include refid="vocManagementCodeCols"/>
        from
            tb_voc_management_cd_bas
        <where>
            <if test="managementCd != null and !managementCd.equals('')">
                management_cd = #{managementCd}
            </if>
            <if test="managementCd == null and prntsCd != null and !prntsCd.equals('')">
                and
                management_cd = #{prntsCd}
            </if>
        </where>
    </select>

    <select id="selectPrcdBas" resultType="com.kspo.voc.kspo.setting.model.VocProcedureBasVo">
        select
            *
        from
            tb_voc_prcd_bas
        where
            prcd_id = #{prcdId}
    </select>

    <select id="selectPrcdBasList" resultType="com.kspo.voc.kspo.setting.model.VocProcedureBasVo">
        select
            *
        from
            tb_voc_prcd_bas
        where
            voc_use_yn = 'Y'
        order by
            prcd_id
    </select>

    <select id="selectTaskBasList" resultType="com.kspo.voc.kspo.setting.model.VocTaskBasVo">
        select
            *
        from
            tb_voc_task_bas
        <where>
            <if test="autoApplyAllYn != null and !autoApplyAllYn.equals('')">
                AUTO_APPLY_ALL_YN = #{autoApplyAllYn}
            </if>
            <if test="autoApplyPrcdId != null and !autoApplyPrcdId.equals('')">
                or
                AUTO_APPLY_PRCD_ID = #{autoApplyPrcdId}
            </if>
            <if test="mcPrcdId != null and !mcPrcdId.equals('')">
                task_id not in (
                    select
                        task_id
                    from
                        tb_voc_mc_task_dtl
                    where
                        mc_prcd_id = #{mcPrcdId}
                )
            </if>
        </where>
    </select>

    <select id="selectActivityFuncBasList" resultType="EzMap">
        select
            *
        from
            tb_voc_activity_func_bas
        where
            func_cd not in (
            select
                func_cd
            from
                tb_voc_activity_dtl
            where
                mc_task_id = #{mcTaskId}
            )
    </select>

    <select id="selectProcedure" resultType="com.kspo.voc.kspo.setting.model.VocProcedureVo">
        select
            *
        from
            tb_voc_procedure
        <where>
            <if test="mcPrcdSeq != null and !mcPrcdSeq.equals('')">
                mc_prcd_seq = #{mcPrcdSeq}
            </if>
            <if test="prntsSeq != null and !prntsSeq.equals('')">
                and
                prnts_seq = #{prntsSeq}
            </if>
        </where>
    </select>

    <select id="selectProcedureList" resultType="com.kspo.voc.kspo.setting.model.VocProcedureVo">
        select
            mc_prcd_seq,
            prnts_seq,
            prcd_seq,
            prcd_nm,
            deadline,
            duty_org,
            duty_emp,
            duty_role,
            regr_id,
            reg_dt,
            amdr_id,
            amd_dt,
            (select task_yn from tb_voc_procedure_bas where prcd_seq = vp.prcd_seq) taskYn
        from
            tb_voc_procedure vp
        where
                vp.mc_prcd_seq in (
                select
                    mc_prcd_seq
                from
                    tb_voc_procedure_dir_conn
                where
                    dir_cd = #{dirCd}
            )
        order by
            3
    </select>

    <select id="selectTaskList" resultType="com.kspo.voc.kspo.setting.model.VocTaskVo">
        select
            mc_task_seq,
            mc_prcd_seq,
            task_seq,
            task_nm,
            odrg,
            deadline,
            duty_org,
            duty_emp,
            duty_role,
            regr_id,
            reg_dt,
            amdr_id,
            amd_dt,
        from
            tb_voc_task
        <where>
            <if test="mcPrcdSeq != null and !mcPrcdSeq.equals('')">
                mc_prcd_seq = #{mcPrcdSeq}
            </if>
        </where>
        order by
            odrg
    </select>

    <select id="selectActivityList" resultMap="VocActivityVo">
        select
            act_seq,
            mc_task_seq,
            func_cd,
            act_nm,
            explanation,
            regr_id,
            reg_dt,
            amdr_id,
            amd_dt
        from
           tb_voc_activity
        <where>
            <if test="mcTaskSeq != null and !mcTaskSeq.equals('')">
                mc_task_seq = #{mcTaskSeq}
            </if>
        </where>
        order by
            1
    </select>

    <select id="selectDirCd" resultType="string">
        select
        dir_cd
        from
        tb_voc_dir_mc_mapping
        <where>
            <if test="managementCd != null and !managementCd.equals('')">
                management_cd = #{managementCd}
            </if>
        </where>
    </select>

    <select id="selectDutyOrgList" resultType="EzMap">
        select
            *
        from
            tb_voc_dir_org_mapping
        where
            dir_cd = #{dirCd}
        order by
            2 desc, 3
    </select>

    <select id="selectRegPrcd" resultType="com.kspo.voc.kspo.process.model.VocPrcdVo">
        select
            *
        from
            tb_voc_reg_prcd
        where
            reg_prcd_seq = #{regPrcdSeq}
    </select>

    <select id="selectRegPrcdList" resultType="com.kspo.voc.kspo.process.model.VocPrcdVo">
        select
            *
        from
            tb_voc_procedure vp inner join tb_voc_reg_prcd vrp
            on vp.mc_prcd_seq = vrp.mc_prcd_seq
        <where>
            <if test="regSeq != null and !regSeq.equals('')">
                vrp.reg_seq = #{regSeq}
            </if>
        </where>
        order by
            reg_prcd_seq
    </select>

    <select id="selectVocStatus" parameterType="string" resultType="map">
        select
            status_cd "statusCd",
            prcd_seq "prcdSeq",
            status_nm "statusNm",
            status "status"
        from
            tb_voc_status
        <where>
            <if test="prcdSeq != null and !prcdSeq.equals('')">
                prcd_seq = #{prcdSeq}
            </if>
            <if test="status != null and !status.equals('')">
                and
                status = #{status}
            </if>
        </where>
    </select>

    <select id="getManagementCodeSelect" resultType="com.kspo.voc.kspo.setting.model.VocManagementCodeVo">
        select
            *
        from
            TB_VOC_MANAGEMENT_CODE
        <where>
            comn_cd = #{comnCd}
            <if test="prntsCd != null and !prntsCd.equals('')">
                and
                prnts_cd = #{prntsCd}
            </if>
            <if test="prntsCd == null">
                and
                prnts_cd = (
                    select
                        management_cd
                    from
                        voc_management_code
                    where
                        comn_cd = #{comnCd}
                        and
                        management_cd = top_cd
                )
            </if>
        </where>
    </select>

    <select id="selectStatusCd" resultType="map">
        select
            *
        from
            tb_voc_status vs inner join tb_voc_procedure_bas vpb
            on vs.PRCD_SEQ = vpb.PRCD_SEQ
        where
            vpb.top_comn_cd = #{topComnCd}
            and
            vpb.comn_cd = #{comnCd}
            and
            vs.status = #{status}
    </select>

    <select id="selectStatusList" resultType="map">
        select
            *
        from
            tb_voc_status
        order by
            1
    </select>

    <!--  upt  -->
    <update id="updateRegistrationStatus">
        update TB_VOC
        set
            status_cd = #{statusCd}
        where
            voc_seq = #{regSeq}
    </update>

    <update id="updateRegPrcd">
        update tb_voc_prcd
        set
            status = #{status}
        where
            voc_prcd_seq = #{vocPrcdSeq}
    </update>






</mapper>
